# GitHub Actions å®šæ—¶ä»»åŠ¡ - Vercel Cron çš„æ›¿ä»£æ–¹æ¡ˆ
# æ¯å¤©å‡Œæ™¨1ç‚¹(UTC)è§¦å‘å‘¨æœŸæ€§ä»»åŠ¡ç”Ÿæˆ

name: Generate Recurring Tasks

on:
  schedule:
    # æ¯å¤© UTC 01:00 (åŒ—äº¬æ—¶é—´ 09:00)
    - cron: '0 1 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºæµ‹è¯•
  workflow_dispatch:

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Recurring Tasks Generation
        run: |
          echo "ğŸ”„ å¼€å§‹ç”Ÿæˆå‘¨æœŸæ€§ä»»åŠ¡..."
          
          # è°ƒç”¨åº”ç”¨çš„å®šæ—¶ä»»åŠ¡API
          curl -X POST "${{ secrets.APP_URL }}/api/cron/generate-recurring-tasks" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail-with-body \
            --max-time 300 \
            --retry 3 \
            --retry-delay 10 \
            -w "HTTP Status: %{http_code}\nTotal time: %{time_total}s\n"
          
          echo "âœ… å‘¨æœŸæ€§ä»»åŠ¡ç”Ÿæˆå®Œæˆ"

      - name: Health Check
        if: always()
        run: |
          echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥åº”ç”¨çŠ¶æ€
          curl -X GET "${{ secrets.APP_URL }}/api/admin/scheduling" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail-with-body \
            --max-time 30 \
            -w "Health check status: %{http_code}\n" || echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥"

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            // å¯ä»¥é›†æˆé€šçŸ¥æœåŠ¡ï¼Œå¦‚Slackã€é‚®ä»¶ç­‰
            console.log('âŒ å‘¨æœŸæ€§ä»»åŠ¡ç”Ÿæˆå¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥')
            
            // ç¤ºä¾‹ï¼šå‘é€åˆ°Webhookï¼ˆéœ€è¦é…ç½® secrets.NOTIFICATION_WEBHOOKï¼‰
            // await fetch(process.env.NOTIFICATION_WEBHOOK, {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify({
            //     text: `âš ï¸ HeroToDoList å‘¨æœŸæ€§ä»»åŠ¡ç”Ÿæˆå¤±è´¥\næ—¶é—´: ${new Date().toISOString()}\néœ€è¦æ£€æŸ¥ç³»ç»ŸçŠ¶æ€`
            //   })
            // })

# æ‰€éœ€çš„ GitHub Secrets:
# APP_URL: åº”ç”¨çš„å®Œæ•´URL (å¦‚: https://your-app.vercel.app)
# CRON_SECRET: å®šæ—¶ä»»åŠ¡APIçš„æˆæƒå¯†é’¥ (ä¸ç¯å¢ƒå˜é‡ CRON_SECRET ç›¸åŒ)
# API_TOKEN: ç®¡ç†APIçš„æˆæƒtoken (å¯é€‰ï¼Œç”¨äºå¥åº·æ£€æŸ¥)
# NOTIFICATION_WEBHOOK: é€šçŸ¥Webhook URL (å¯é€‰)