# 微信公众号任务添加功能

本项目已集成微信公众号功能，用户可以通过微信公众号直接创建和管理任务。

## 🚀 功能特色

### 核心功能
- **微信账号绑定**: 通过安全的绑定流程关联微信账号和系统账号
- **自然语言任务创建**: 直接发送文本消息即可创建任务
- **智能任务解析**: 自动识别时间、优先级、标签等任务属性
- **指令系统**: 丰富的指令支持各种操作
- **实时反馈**: 任务创建成功后即时反馈详细信息

### 支持的任务格式
- **基本格式**: `学习Vue.js`
- **带时间**: `明天下午3点开会`、`12月25日提交报告`  
- **带标签**: `买菜 #生活`、`项目会议 #工作`
- **带优先级**: `完成论文 !重要`、`紧急修复bug !紧急`
- **组合格式**: `明天下午2点项目评审会议 #工作 !重要`

## 📋 指令系统

### 基础指令
- `/help` - 显示帮助信息
- `/bind` - 绑定HeroToDo账号  
- `/unbind` - 解除账号绑定
- `/status` - 查看绑定状态
- `/stats` - 查看任务统计
- `/list` - 查看最近任务

### 任务属性标记
- **时间标记**: `今天`、`明天`、`后天`、`12月25日`
- **标签标记**: `#工作`、`#学习`、`#生活`
- **优先级标记**: `!重要`、`!紧急`、`!低`

## 🔧 配置说明

### 环境变量配置
在 `.env` 文件中添加微信公众号相关配置：

```env
# 微信公众号配置
WECHAT_APP_ID="你的微信公众号AppID"
WECHAT_APP_SECRET="你的微信公众号AppSecret" 
WECHAT_TOKEN="你设置的Token"
WECHAT_ENCODING_AES_KEY="加密密钥（可选）"
```

### 微信公众号设置
1. 登录微信公众平台
2. 进入"开发 > 基本配置"
3. 设置服务器配置：
   - URL: `https://yourdomain.com/api/wechat/webhook`
   - Token: 与环境变量中的 `WECHAT_TOKEN` 保持一致
   - EncodingAESKey: 可选，用于消息加密
   - 消息加解密方式: 推荐选择"安全模式"

## 👥 用户使用流程

### 1. 账号绑定
1. 关注微信公众号
2. 发送 `/bind` 指令
3. 点击返回的绑定链接
4. 使用邮箱登录HeroToDo账号
5. 完成绑定

### 2. 创建任务
绑定成功后，直接发送任务内容即可：
```
明天上午10点参加项目会议 #工作 !重要
```

系统会自动解析并创建任务，返回创建成功的确认信息。

### 3. 查看任务状态
- 发送 `/stats` 查看通过微信创建的任务统计
- 发送 `/list` 查看最近的未完成任务
- 发送 `/status` 确认绑定状态

## 🏗️ 技术架构

### 数据库模型
- **WechatUser**: 微信用户信息和绑定状态
- **WechatMessage**: 微信消息处理记录
- **WechatTaskLog**: 任务创建日志

### API端点
- `GET/POST /api/wechat/webhook` - 微信消息处理
- `POST /api/wechat/bind` - 账号绑定接口
- `GET /api/wechat/user/[openid]` - 微信用户信息查询

### 管理功能
- 微信用户管理界面 (`/admin/wechat-users`)
- 用户绑定状态监控
- 任务创建统计分析
- 消息处理状态跟踪

## 🔐 安全特性

### 消息验证
- 微信服务器签名验证
- 防重放攻击机制
- 安全的绑定令牌生成

### 数据保护
- 用户隐私信息加密存储
- 绑定令牌自动过期（30分钟）
- 完整的操作日志记录

### 权限控制
- 管理员权限验证
- 用户数据访问控制
- API接口安全防护

## 📊 监控与管理

### 管理后台功能
- 微信用户列表和状态监控
- 绑定统计和活跃用户分析
- 任务创建成功率统计
- 消息处理状态跟踪

### 日志记录
- 完整的消息处理日志
- 任务创建成功/失败记录
- 用户活跃时间追踪
- 错误信息详细记录

## 🚨 故障处理

### 常见问题
1. **绑定失败**: 检查令牌是否过期，重新获取绑定链接
2. **消息无响应**: 验证微信公众号配置和服务器连通性
3. **任务创建失败**: 检查账号绑定状态和任务格式

### 调试信息
- 服务器日志位于控制台输出
- 数据库记录了完整的处理过程
- 管理后台提供实时状态监控

## 🔄 部署说明

### 生产环境配置
1. 确保服务器支持HTTPS
2. 配置正确的域名和端口
3. 设置环境变量
4. 运行数据库迁移
5. 测试微信服务器连接

### 扩展性考虑
- 支持消息队列处理高并发
- 可扩展支持多个微信公众号
- 预留语音消息转文字接口
- 支持图片消息处理扩展

---

## 📝 更新日志

### v1.0.0 (2024-08-29)
- ✅ 完成微信公众号基础集成
- ✅ 实现用户绑定和身份验证
- ✅ 支持自然语言任务创建
- ✅ 添加完整的指令系统
- ✅ 完成管理后台功能
- ✅ 实现安全验证和日志记录

如有问题或建议，请提交 Issue 或联系开发团队。